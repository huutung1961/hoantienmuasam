<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Táº¡o Link Shopee Affiliate - Láº¥y GiÃ¡ & NgÃ nh HÃ ng</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9fafb; text-align: center; padding: 40px 20px; }
    h1 { color: #ff5722; margin-bottom: 20px; }
    .container { background: white; padding: 30px; border-radius: 12px; max-width: 520px; margin: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    input, button { padding: 12px; margin: 10px 0; width: 90%; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #ff5722; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #e64a19; }
    #result, #commission, #categoryName { margin-top: 15px; font-weight: bold; word-break: break-word; }
    #categoryName { color: #2196F3; }
    #result { color: green; }
    #commission { color: #4CAF50; }
    #copyBtn { margin-top: 10px; padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; display: none; }
    #copyBtn:hover { background: #388E3C; }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ”— Shopee Affiliate Tool</h1>
  <p>DÃ¡n link Shopee â†’ Láº¥y giÃ¡ & ngÃ nh hÃ ng â†’ Táº¡o link Affiliate + TÃ­nh hoa há»“ng.</p>

  <input type="text" id="productLink" placeholder="DÃ¡n link sáº£n pháº©m Shopee táº¡i Ä‘Ã¢y" onblur="fetchProductData()">

  <div id="categoryName">ğŸ“‚ NgÃ nh hÃ ng: <i>ChÆ°a cÃ³ dá»¯ liá»‡u</i></div>
  <div>ğŸ’µ GiÃ¡: <input type="number" id="productPrice" placeholder="GiÃ¡ sáº£n pháº©m (tá»± láº¥y)" readonly></div>

  <button onclick="generateLink()">Táº¡o Link + TÃ­nh Hoa há»“ng</button>

  <div id="result"></div>
  <div id="commission"></div>
  <button id="copyBtn" onclick="copyLink()">ğŸ“‹ Copy Link</button>
</div>

<script>
const affiliateID = "17337560220";
let generatedLink = "";
let categoryList = []; // Danh sÃ¡ch ngÃ nh hÃ ng Shopee
let categoryName = "";
let commissionRate = 0.05; // máº·c Ä‘á»‹nh 5%

// ğŸ‘‰ HÃ m tÃ¡ch shopid & itemid tá»« link Shopee
function extractIDs(url) {
  let match = url.match(/i\.(\d+)\.(\d+)/);
  if (match) {
    return { shopid: match[1], itemid: match[2] };
  }
  return null;
}

// ğŸ‘‰ Láº¥y toÃ n bá»™ danh sÃ¡ch ngÃ nh hÃ ng 1 láº§n duy nháº¥t
function fetchCategories() {
  return fetch("https://shopee.vn/api/v4/category/get_all")
    .then(res => res.json())
    .then(data => {
      categoryList = data.data.category_list;
    })
    .catch(err => console.error("âš ï¸ KhÃ´ng láº¥y Ä‘Æ°á»£c danh má»¥c Shopee", err));
}

// ğŸ‘‰ Láº¥y dá»¯ liá»‡u sáº£n pháº©m (giÃ¡ + catid)
async function fetchProductData() {
  let originalLink = document.getElementById("productLink").value.trim();
  let ids = extractIDs(originalLink);
  
  if (!ids) {
    alert("âš ï¸ KhÃ´ng tÃ¬m tháº¥y shopid & itemid trong link Shopee!");
    return;
  }

  // Náº¿u chÆ°a cÃ³ danh má»¥c thÃ¬ táº£i trÆ°á»›c
  if (categoryList.length === 0) {
    await fetchCategories();
  }

  let apiUrl = `https://shopee.vn/api/v4/item/get?itemid=${ids.itemid}&shopid=${ids.shopid}`;

  fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
      if (data.item) {
        // Láº¥y giÃ¡
        let price = data.item.price / 100000;
        document.getElementById("productPrice").value = price;

        // Láº¥y ngÃ nh hÃ ng
        let catid = data.item.catid;
        let foundCategory = findCategoryName(catid);
        categoryName = foundCategory ? foundCategory : "KhÃ´ng xÃ¡c Ä‘á»‹nh";
        document.getElementById("categoryName").innerHTML = "ğŸ“‚ NgÃ nh hÃ ng: <b>" + categoryName + "</b>";

        // Táº¡m thá»i set hoa há»“ng cÆ¡ báº£n theo ngÃ nh
        commissionRate = estimateCommissionRate(catid);
      } else {
        alert("âš ï¸ KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u sáº£n pháº©m.");
      }
    })
    .catch(err => {
      console.error(err);
      alert("âš ï¸ Lá»—i khi gá»i API Shopee.");
    });
}

// ğŸ‘‰ TÃ¬m tÃªn ngÃ nh hÃ ng tá»« catid
function findCategoryName(catid) {
  for (let cat of categoryList) {
    if (cat.catid === catid) return cat.display_name;
    if (cat.children) {
      for (let sub of cat.children) {
        if (sub.catid === catid) return sub.display_name;
        if (sub.children) {
          for (let subsub of sub.children) {
            if (subsub.catid === catid) return subsub.display_name;
          }
        }
      }
    }
  }
  return null;
}

// ğŸ‘‰ Æ¯á»›c tÃ­nh % hoa há»“ng theo ngÃ nh (Ä‘Æ¡n giáº£n hÃ³a)
function estimateCommissionRate(catid) {
  // Báº¡n cÃ³ thá»ƒ custom sÃ¢u hÆ¡n theo báº£ng cá»§a Shopee
  if (!categoryName) return 0.05;
  if (categoryName.includes("Thá»i Trang")) return 0.10;
  if (categoryName.includes("Äiá»‡n Thoáº¡i") || categoryName.includes("Äiá»‡n tá»­")) return 0.03;
  if (categoryName.includes("Má»¹ pháº©m") || categoryName.includes("Sá»©c khá»e")) return 0.08;
  return 0.05;
}

// ğŸ‘‰ HÃ m táº¡o link + tÃ­nh hoa há»“ng
function generateLink() {
  let originalLink = document.getElementById("productLink").value.trim();
  let productPrice = parseFloat(document.getElementById("productPrice").value);

  if (!originalLink.includes("shopee")) {
    alert("âš ï¸ HÃ£y nháº­p Ä‘Ãºng link sáº£n pháº©m Shopee!");
    return;
  }
  if (isNaN(productPrice) || productPrice <= 0) {
    alert("âš ï¸ KhÃ´ng cÃ³ giÃ¡ sáº£n pháº©m.");
    return;
  }

  // Gáº¯n aff_id vÃ o link
  if (originalLink.includes("?")) {
    generatedLink = originalLink + "&aff_id=" + affiliateID;
  } else {
    generatedLink = originalLink + "?aff_id=" + affiliateID;
  }

  // TÃ­nh hoa há»“ng
  let commission = productPrice * commissionRate;

  document.getElementById("result").innerHTML = `
    âœ… Link Affiliate:<br>
    <a href="${generatedLink}" target="_blank">${generatedLink}</a>
  `;
  document.getElementById("commission").innerHTML = 
    `ğŸ’° <b>Hoa há»“ng Æ°á»›c tÃ­nh: ${commission.toLocaleString()} Ä‘</b>`;

  document.getElementById("copyBtn").style.display = "inline-block";
}

function copyLink() {
  navigator.clipboard.writeText(generatedLink).then(() => {
    alert("ğŸ“‹ Link Ä‘Ã£ Ä‘Æ°á»£c copy!");
  });
}

// Gá»i API categories khi load trang Ä‘á»ƒ cache sáºµn
fetchCategories();
</script>

</body>
</html>
