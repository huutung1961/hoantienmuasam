<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Táº¡o Link Shopee Affiliate & Æ¯á»›c TÃ­nh hoa há»“ng</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9fafb; text-align: center; padding: 50px 20px; }
    h1 { color: #ff5722; margin-bottom: 20px; }
    .container { background: white; padding: 30px; border-radius: 12px; max-width: 500px; margin: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    input, button { padding: 12px; margin: 10px 0; width: 90%; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #ff5722; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #e64a19; }
    #result, #details { margin-top: 20px; font-weight: bold; word-break: break-all; }
    #result a { color: green; }
    #details { color: #388E3C; }
    #copyBtn { margin-top: 10px; padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; display: none; }
    #copyBtn:hover { background: #388E3C; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”— Táº¡o Link Shopee Affiliate</h1>
    <p>DÃ¡n link sáº£n pháº©m Shopee (rÃºt gá»n hoáº·c Ä‘áº§y Ä‘á»§) Ä‘á»ƒ táº¡o link Affiliate vÃ  láº¥y thÃ´ng tin.</p>
    <input type="text" id="productLink" placeholder="DÃ¡n link sáº£n pháº©m Shopee táº¡i Ä‘Ã¢y nhÃ©" onpaste="generateLink()">
    <br>
    <button onclick="generateLink()">Táº¡o Link & Láº¥y ThÃ´ng Tin</button>
    <div id="result"></div>
    <div id="details"></div>
    <button id="copyBtn" onclick="copyLink()">ğŸ“‹ Copy Link</button>
  </div>
  <script>
    const affiliateID = "17337560220";
    let generatedLink = "";
    const commissionRates = { "fashion": 10, "electronics": 5, "beauty": 15, "home": 8, "default": 5 };

    async function generateLink() {
      let originalLink = document.getElementById("productLink").value.trim();
      if (!originalLink.includes("shopee")) {
        alert("âš ï¸ HÃ£y nháº­p Ä‘Ãºng link sáº£n pháº©m Shopee!");
        return;
      }

      // Giáº£i mÃ£ link rÃºt gá»n thÃ nh link Ä‘áº§y Ä‘á»§
      let fullLink = await resolveShortLink(originalLink);
      if (originalLink.includes("?")) {
        generatedLink = fullLink + "&aff_id=" + affiliateID;
      } else {
        generatedLink = fullLink + "?aff_id=" + affiliateID;
      }

      // Láº¥y giÃ¡ vÃ  thÃ´ng tin
      let price = await scrapePrice(fullLink);
      if (price === 0) {
        alert("âš ï¸ KhÃ´ng thá»ƒ láº¥y giÃ¡. Vui lÃ²ng kiá»ƒm tra link hoáº·c dÃ¹ng link Ä‘áº§y Ä‘á»§!");
      }
      let category = detectCategory(fullLink);
      let commissionRate = commissionRates[category] || commissionRates["default"];
      let estimatedCommission = (commissionRate * price) / 100;

      let details = `
        ğŸ” GiÃ¡ thá»±c táº¿: ${price.toLocaleString()} VNÄ<br>
        ğŸ·ï¸ Danh má»¥c: ${category}<br>
        ğŸ’° Hoa há»“ng Æ°á»›c tÃ­nh: ${estimatedCommission.toLocaleString()} VNÄ (${commissionRate}%)
      `;

      document.getElementById("result").innerHTML = `
        âœ… Link Affiliate Ä‘Ã£ táº¡o:<br>
        <a href="${generatedLink}" target="_blank">${generatedLink}</a>
      `;
      document.getElementById("details").innerHTML = details;
      document.getElementById("copyBtn").style.display = "inline-block";
    }

    // Giáº£i mÃ£ link rÃºt gá»n
    async function resolveShortLink(shortUrl) {
      try {
        let response = await fetch(shortUrl, { method: "HEAD", redirect: "follow" });
        return response.url; // Tráº£ vá» URL Ä‘Ã­ch
      } catch (error) {
        console.error("Lá»—i khi giáº£i mÃ£ link:", error);
        // Thá»­ fetch trá»±c tiáº¿p Ä‘á»ƒ láº¥y redirect
        try {
          let response = await fetch(shortUrl);
          return response.url;
        } catch (e) {
          console.error("Lá»—i khi fetch redirect:", e);
          return shortUrl; // Náº¿u tháº¥t báº¡i, dÃ¹ng link gá»‘c
        }
      }
    }

    // Scrape giÃ¡ tá»« trang
    async function scrapePrice(url) {
      try {
        let response = await fetch(url);
        let text = await response.text();
        let parser = new DOMParser();
        let doc = parser.parseFromString(text, "text/html");
        let priceElement = doc.querySelector(".product-price") || doc.querySelector(".price") || doc.querySelector(".product-detail__price");
        if (priceElement) {
          let priceText = priceElement.textContent.trim().replace(/[^0-9]/g, '');
          return parseInt(priceText) || 0;
        }
        return 0; // KhÃ´ng tÃ¬m tháº¥y giÃ¡
      } catch (error) {
        console.error("Lá»—i khi scrape:", error);
        return 0;
      }
    }

    // PhÃ¡t hiá»‡n danh má»¥c
    function detectCategory(link) {
      if (link.includes("fashion")) return "fashion";
      if (link.includes("electronics")) return "electronics";
      if (link.includes("beauty")) return "beauty";
      if (link.includes("home")) return "home";
      return "default";
    }

    function copyLink() {
      navigator.clipboard.writeText(generatedLink).then(() => {
        alert("ğŸ“‹ Link Ä‘Ã£ Ä‘Æ°á»£c copy!");
      });
    }
  </script>
</body>
</html>
